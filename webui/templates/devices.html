{% extends "base.html" %}

{% block title %}Ger√§te - EMS-Core{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="/">Home</a>
    <span class="separator">‚Ä∫</span>
    <span>Ger√§te</span>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .devices-grid {
        display: grid;
        gap: 20px;
    }

    .device-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
    }

    .device-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .device-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .device-info {
        flex: 1;
    }

    .device-name {
        font-size: 1.2em;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 5px;
    }

    .device-meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .device-icon {
        font-size: 2em;
        margin-right: 15px;
    }

    .device-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin: 15px 0;
        padding: 15px;
        background: var(--gray-50);
        border-radius: 8px;
    }

    .stat {
        text-align: center;
    }

    .stat-label {
        font-size: 0.8em;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 1.3em;
        font-weight: 600;
        color: var(--gray-900);
    }

    .control-panel {
        display: flex;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid var(--gray-200);
    }

    .control-group {
        display: flex;
        gap: 8px;
        flex: 1;
    }

    .override-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--gray-50);
        border-radius: 6px;
        font-size: 0.9em;
    }

    .override-status.active {
        background: #fef3c7;
        color: #92400e;
    }

    .override-icon {
        font-size: 1.1em;
    }

    /* Loading State */
    .device-card.loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Filter Bar */
    .filter-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-group label {
        font-size: 0.9em;
        color: var(--gray-600);
    }

    .filter-group select,
    .filter-group input {
        padding: 8px 12px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        font-size: 0.9em;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray-500);
    }

    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üîå Ger√§te</h1>
    <p>Verwalte und steuere deine Smart-Home Ger√§te</p>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-group">
        <label>Filter:</label>
        <select id="filter-type" onchange="filterDevices()">
            <option value="all">Alle Typen</option>
            <option value="shelly_plug">Shelly Plug</option>
            <option value="shelly_1pm">Shelly 1PM</option>
            <option value="sg_ready">SG-Ready</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Priorit√§t:</label>
        <select id="filter-priority" onchange="filterDevices()">
            <option value="all">Alle</option>
            <option value="CRITICAL">CRITICAL</option>
            <option value="HIGH">HIGH</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="LOW">LOW</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Suche:</label>
        <input type="text" id="search-input" placeholder="Ger√§t suchen..." oninput="filterDevices()">
    </div>
    <div class="filter-group" style="margin-left: auto;">
        <button class="btn btn-secondary btn-sm" onclick="refreshDevices()">
            üîÑ Aktualisieren
        </button>
    </div>
</div>

<!-- Devices Grid -->
<div class="devices-grid" id="devices-grid">
    <div class="empty-state">
        <div class="loading"></div>
        <p>Lade Ger√§te...</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let devices = [];
    let overrides = {};

    // Load Devices
    async function loadDevices() {
        try {
            const response = await fetch('/api/devices');
            const data = await response.json();
            
            if (data.success) {
                devices = data.devices;
                await loadOverrides();
                renderDevices();
            } else {
                showNotification('Fehler beim Laden der Ger√§te', 'error');
            }
        } catch (error) {
            console.error('Error loading devices:', error);
            showNotification('Verbindungsfehler', 'error');
        }
    }

    // Load Overrides
    async function loadOverrides() {
        try {
            const response = await fetch('/api/override/status');
            const data = await response.json();
            
            if (data.success) {
                overrides = data.overrides;
            }
        } catch (error) {
            console.error('Error loading overrides:', error);
        }
    }

    // Render Devices
    function renderDevices() {
        const grid = document.getElementById('devices-grid');
        
        if (devices.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîå</div>
                    <h3>Keine Ger√§te gefunden</h3>
                    <p>F√ºge Ger√§te √ºber die API hinzu</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = devices.map(device => {
            const override = overrides[device.id];
            const hasOverride = override && override.active;
            const overrideMode = hasOverride ? override.mode : 'auto';

            return `
                <div class="device-card" data-id="${device.id}" data-type="${device.type}" data-priority="${device.priority}">
                    <div class="device-card-header">
                        <div class="device-info">
                            <div style="display: flex; align-items: center;">
                                <span class="device-icon">${getDeviceIcon(device.type)}</span>
                                <div>
                                    <div class="device-name">${device.name}</div>
                                    <div class="device-meta">
                                        <span class="badge badge-${getPriorityColor(device.priority)}">${device.priority}</span>
                                        <span class="badge badge-secondary">${device.type}</span>
                                        ${device.enabled ? '<span class="badge badge-success">Aktiv</span>' : '<span class="badge badge-secondary">Inaktiv</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="device-stats">
                        <div class="stat">
                            <div class="stat-label">IP</div>
                            <div class="stat-value" style="font-size: 1em;">${device.ip}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Leistung</div>
                            <div class="stat-value">${device.power}W</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Raum</div>
                            <div class="stat-value" style="font-size: 0.9em;">${device.room || '-'}</div>
                        </div>
                    </div>

                    ${hasOverride ? `
                        <div class="override-status active">
                            <span class="override-icon">üë§</span>
                            <span>Manuell: ${overrideMode === 'manual_on' ? 'EIN' : 'AUS'}</span>
                        </div>
                    ` : ''}

                    <div class="control-panel">
                        <div class="control-group">
                            <button class="btn btn-success btn-sm" 
                                    onclick="setOverride('${device.id}', 'manual_on')"
                                    ${overrideMode === 'manual_on' ? 'disabled' : ''}>
                                ‚ñ∂Ô∏è EIN
                            </button>
                            <button class="btn btn-danger btn-sm" 
                                    onclick="setOverride('${device.id}', 'manual_off')"
                                    ${overrideMode === 'manual_off' ? 'disabled' : ''}>
                                ‚è∏Ô∏è AUS
                            </button>
                            <button class="btn btn-secondary btn-sm" 
                                    onclick="setOverride('${device.id}', 'auto')"
                                    ${overrideMode === 'auto' ? 'disabled' : ''}>
                                ü§ñ AUTO
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Set Override
    async function setOverride(deviceId, mode) {
        const card = document.querySelector(`[data-id="${deviceId}"]`);
        card.classList.add('loading');

        try {
            let endpoint;
            if (mode === 'manual_on') {
                endpoint = `/api/override/${deviceId}/manual_on`;
            } else if (mode === 'manual_off') {
                endpoint = `/api/override/${deviceId}/manual_off`;
            } else {
                endpoint = `/api/override/${deviceId}/auto`;
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    duration_minutes: 60,
                    reason: 'Manuelle Steuerung via WebUI'
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`Ger√§t ${deviceId} auf ${mode.toUpperCase()} gesetzt`, 'success');
                await loadOverrides();
                renderDevices();
            } else {
                showNotification('Fehler beim Setzen des Override', 'error');
            }
        } catch (error) {
            console.error('Error setting override:', error);
            showNotification('Verbindungsfehler', 'error');
        } finally {
            card.classList.remove('loading');
        }
    }

    // Filter Devices
    function filterDevices() {
        const typeFilter = document.getElementById('filter-type').value;
        const priorityFilter = document.getElementById('filter-priority').value;
        const searchQuery = document.getElementById('search-input').value.toLowerCase();

        const cards = document.querySelectorAll('.device-card');

        cards.forEach(card => {
            const type = card.dataset.type;
            const priority = card.dataset.priority;
            const name = card.querySelector('.device-name').textContent.toLowerCase();

            const typeMatch = typeFilter === 'all' || type === typeFilter;
            const priorityMatch = priorityFilter === 'all' || priority === priorityFilter;
            const searchMatch = searchQuery === '' || name.includes(searchQuery);

            if (typeMatch && priorityMatch && searchMatch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Refresh Devices
    async function refreshDevices() {
        await loadDevices();
        showNotification('Ger√§te aktualisiert', 'info');
    }

    // Helper Functions
    function getDeviceIcon(type) {
        const icons = {
            'shelly_plug': 'üîå',
            'shelly_1pm': 'üîå',
            'shelly_plus_1pm': 'üîå',
            'sg_ready': '‚ô®Ô∏è',
            'generic': '‚öôÔ∏è'
        };
        return icons[type] || '‚öôÔ∏è';
    }

    function getPriorityColor(priority) {
        const colors = {
            'CRITICAL': 'danger',
            'HIGH': 'warning',
            'MEDIUM': 'info',
            'LOW': 'secondary',
            'OPTIONAL': 'secondary'
        };
        return colors[priority] || 'secondary';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadDevices();

        // Auto-refresh every 30 seconds
        setInterval(loadDevices, 30000);
    });
</script>
{% endblock %}
